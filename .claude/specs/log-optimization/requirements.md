# 日志系统优化需求文档

## 1. 介绍

本文档定义了 Claude Code Router 项目日志系统优化的功能需求。当前系统存在两个主要问题：

1. **日志存储问题**：所有日志都写入单个文件，导致日志文件过大，缺乏错误日志分离和自动轮转机制
2. **请求停止问题**：请求未能正确停止时，日志中缺少关键状态信息（如 `finish_reason`），导致难以诊断和追踪问题

本优化旨在提升日志管理的可维护性和问题诊断能力。

## 2. 功能需求

### 2.1 日志存储优化

#### 2.1.1 日志级别分离
**用户故事**：作为一名系统管理员，我想要将错误日志与普通日志分开存储，以便快速定位和排查问题。

**接受标准**：
- 当日志级别 >= 40 (error/warn) 时，写入错误日志文件
- 当日志级别 < 40 (info/debug) 时，写入普通日志文件
- 所有日志级别定义遵循 pino 日志库标准：
  - 10: trace
  - 20: debug  
  - 30: info
  - 40: warn
  - 50: error
  - 60: fatal
- **注意**：当前系统使用简单的自定义日志函数，需要升级到支持日志级别的标准日志库

#### 2.1.2 日志轮转机制
**用户故事**：作为一名系统管理员，我想要日志按日期自动轮转，避免单个日志文件过大影响性能和管理。

**接受标准**：
- 每日自动创建新的日志文件
- 日志文件按日期命名：`YYYY-MM-DD-{type}.log`
- 支持配置日志保留天数（默认7天）
- 自动清理过期日志文件
- 日志文件存放在 `~/.claude-code-router/logs/` 目录下

#### 2.1.3 日志文件目录结构
**用户故事**：作为一名开发者，我想要清晰的日志文件组织结构，便于查找和管理日志文件。

**接受标准**：
- 创建专用的日志目录：`~/.claude-code-router/logs/`
- 目录结构如下：
  ```
  ~/.claude-code-router/logs/
  ├── 2025-08-03-info.log      # 普通日志
  ├── 2025-08-03-error.log     # 错误日志
  ├── 2025-08-04-info.log
  ├── 2025-08-04-error.log
  └── ...
  ```
- 保持向后兼容，原有的 `~/.claude-code-router/claude-code-router.log` 文件仍可读取
- 在迁移阶段支持同时写入新旧日志文件

### 2.2 请求状态追踪优化

#### 2.2.1 请求生命周期日志
**用户故事**：作为一名开发者，我想要完整的请求生命周期日志记录，包括开始、进行中和结束状态，以便分析请求执行过程。

**接受标准**：
- 记录请求开始时间戳
- 记录请求结束时间戳  
- 记录请求执行时长
- 记录请求的 provider、model 等关键信息
- 记录请求的 token 使用情况
- 记录请求的最终状态（成功/失败）
- 为每个请求生成唯一的请求ID，便于追踪

#### 2.2.2 流式响应状态追踪
**用户故事**：作为一名运维人员，我想要准确追踪流式响应的状态，特别是区分正常的流式传输中间状态和异常的请求中断。

**接受标准**：
- 记录流式响应的开始状态
- 记录流式传输过程中的中间状态（finish_reason: null 是正常的）
- 记录流式响应的正常结束状态（finish_reason: "stop"）
- 记录流式响应的异常中断状态（超时、连接断开等）
- 当流式响应异常结束时，记录具体的错误信息
- 区分正常的流式传输中间状态和真正的异常中断

#### 2.2.3 错误日志增强
**用户故事**：作为一名开发者，我想要详细的错误日志信息，包括请求上下文，以便快速定位和解决问题。

**接受标准**：
- 记录所有级别的错误信息
- 错误日志包含完整的请求上下文信息
- 记录错误发生的时间戳、错误类型、错误消息
- 记录与错误相关的请求ID、provider、model等信息
- 支持错误日志的单独存储和查询

## 3. 技术需求

### 3.1 性能要求
- 日志写入不应显著影响系统性能
- 日志轮转过程不应阻塞正常请求处理
- 支持并发日志写入

### 3.2 可配置性
- 支持通过配置文件调整日志级别
- 支持配置日志保留天数
- 支持配置日志文件路径
- 支持启用/禁用日志分离功能

### 3.3 向后兼容性
- 保持现有日志格式的兼容性
- 不破坏现有的日志解析工具
- 支持读取历史日志文件

### 3.4 错误处理
- 日志系统自身出错不应影响主应用运行
- 提供日志写入失败的降级机制
- 记录日志系统自身的错误信息

## 4. 边界情况考虑

### 4.1 磁盘空间不足
- 当磁盘空间不足时，应优先保留最新的日志文件
- 提供磁盘空间监控和告警机制
- 支持日志文件压缩存储

### 4.2 高频日志写入
- 支持日志写入缓冲机制
- 避免日志文件句柄泄露
- 支持日志写入队列机制

### 4.3 时区处理
- 日志文件名使用 UTC 时区
- 日志内容时间戳使用本地时区或可配置时区

## 5. 成功标准

### 5.1 功能验收标准
- [ ] 错误日志正确写入单独文件
- [ ] 普通日志正确写入单独文件  
- [ ] 每日自动创建新日志文件
- [ ] 过期日志文件自动清理
- [ ] 所有请求日志包含 `finish_reason` 字段
- [ ] 日志系统不影响主应用性能
- [ ] 配置项生效且可动态调整

### 5.2 性能验收标准
- 日志写入延迟 < 10ms
- 日志轮转时 CPU 使用率 < 5%
- 单个日志文件大小 < 100MB（默认配置）

### 5.3 可靠性验收标准
- 日志系统自身错误恢复时间 < 1s
- 日志数据完整性 100%
- 系统崩溃时日志数据丢失率 < 1%